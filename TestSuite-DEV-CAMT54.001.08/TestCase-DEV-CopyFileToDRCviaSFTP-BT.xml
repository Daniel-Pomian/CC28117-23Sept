<?xml version="1.0" encoding="UTF-8"?>
<con:testCase id="9aa6253f-f401-4692-9500-e8877d29e24c" discardOkResults="true" failOnError="false" failTestCaseOnErrors="true" keepSession="false" name="TestCase-DEV-CopyFileToDRCviaSFTP-BT" searchProperties="true" timeout="0" wsrmEnabled="false" wsrmVersion="1.0" wsrmAckTo="" amfAuthorisation="false" amfEndpoint="" amfLogin="" amfPassword="" maxResults="0" xmlns:con="http://eviware.com/soapui/config">
  <con:description>Copied file to target directory for bank transfer based on user stories:
User story: https://www.sg.de.o2.com/jira/browse/DRC-2498
https://www.sg.de.o2.com/jira/browse/DRC-2499</con:description>
  <con:settings>
    <con:setting id="3a36338c-603f-4112-9dd8-394f09709fa7fileName">TestCase-DEV-CopyFileToDRCviaSFTP</con:setting>
    <con:setting id="83e57bed-9b56-44fd-8050-ace0e5d30c24fileName">TestCase-DEV-CopyFileToDRCviaSFTP-BT</con:setting>
    <con:setting id="9aa6253f-f401-4692-9500-e8877d29e24cfileName">TestCase-DEV-CopyFileToDRCviaSFTP-BT</con:setting>
  </con:settings>
  <con:savedRecentRuns>1</con:savedRecentRuns>
  <con:testStep type="transfer" name="_Property Transfer-ClearValues" id="57ebf613-eea1-42a5-8d21-ff2bc2700779">
    <con:settings/>
    <con:config xsi:type="con:PropertyTransfersStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
      <con:transfers setNullOnMissingSource="true" transferTextContent="true" failOnError="false" ignoreEmpty="false" transferToAll="false" entitize="false" transferChildNodes="false">
        <con:name>1</con:name>
        <con:sourceType>StringEmpty</con:sourceType>
        <con:sourceStep>#Project#</con:sourceStep>
        <con:sourcePath/>
        <con:targetType>targetPath</con:targetType>
        <con:targetStep>#TestCase#</con:targetStep>
        <con:targetPath/>
        <con:upgraded>true</con:upgraded>
      </con:transfers>
      <con:transfers setNullOnMissingSource="true" transferTextContent="true" failOnError="false" disabled="false" entitize="false" ignoreEmpty="false" transferChildNodes="false" transferToAll="false" useXQuery="false">
        <con:name>2</con:name>
        <con:sourceType>StringEmpty</con:sourceType>
        <con:sourceStep>#Project#</con:sourceStep>
        <con:sourcePath/>
        <con:targetType>targetUser</con:targetType>
        <con:targetStep>#TestCase#</con:targetStep>
        <con:targetPath/>
        <con:type>XPATH</con:type>
        <con:targetTransferType>XPATH</con:targetTransferType>
        <con:upgraded>true</con:upgraded>
      </con:transfers>
    </con:config>
  </con:testStep>
  <con:testStep type="request" name="GUI_getSettingChildNodes-sftpPath-BT" id="88b3f601-3b9e-4c43-896e-073bdd6696e3">
    <con:settings/>
    <con:config xsi:type="con:RequestStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
      <con:interface>DrcGuiSoapBinding</con:interface>
      <con:operation>getSettingChildNodes</con:operation>
      <con:request name="GUI_getSettingChildNodes-sftpPath-BT" id="4f9c02c6-07fa-485b-83f5-ae70d3e3b0da">
        <con:settings>
          <con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;xml-fragment/></con:setting>
        </con:settings>
        <con:encoding>UTF-8</con:encoding>
        <con:endpoint>${#Project#drc-GUIService-URL}</con:endpoint>
        <con:request><![CDATA[<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:type="http://directrecharge.o2.com/ws/drcgui/v1/" xmlns:v1="http://directrecharge.o2.com/ws/common/settings/v1/">
   <soapenv:Header/>
   <soapenv:Body>
      <v1:getSettingChildNodes>
         <settingPath>
            <settingName>com.o2.directrecharge.core.settings.SettingsRootCategoryEnum.MFT_ROOT</settingName>
            <settingName>com.o2.directrecharge.adapter.mft.PaymentStandardsEnum.BT</settingName>
            <settingName>com.o2.directrecharge.adapter.mft.MFTSettingsEnum.PATH_TO_CAMT_054_001_02</settingName>
         </settingPath>
      </v1:getSettingChildNodes>
   </soapenv:Body>
</soapenv:Envelope>]]></con:request>
        <con:assertion type="SOAP Response" id="6095dc36-6354-489f-9c3f-7008d934a9a1"/>
        <con:assertion type="Schema Compliance" id="8ff4d012-227e-4d6b-996e-5f2becf7d4ab">
          <con:configuration/>
        </con:assertion>
        <con:assertion type="SOAP Fault Assertion" id="c763efec-5e2a-49f8-9170-35713589853c"/>
        <con:credentials>
          <con:selectedAuthProfile>Inherit From Parent</con:selectedAuthProfile>
          <con:authType>No Authorization</con:authType>
        </con:credentials>
        <con:jmsConfig JMSDeliveryMode="PERSISTENT"/>
        <con:wsaConfig mustUnderstand="NONE" version="200508"/>
        <con:wsrmConfig version="1.2"/>
        <con:environmentSpec>
          <con:entry environmentId="e385afea-1153-4d90-83b9-3b49a724f0ea">
            <con:authProfile>Inherit From Parent</con:authProfile>
          </con:entry>
        </con:environmentSpec>
      </con:request>
    </con:config>
  </con:testStep>
  <con:testStep type="request" name="GUI_getSettingChildNodes-userName-BT" id="bc079c74-a3db-42cb-a091-7703f60141d1">
    <con:settings/>
    <con:config xsi:type="con:RequestStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
      <con:interface>DrcGuiSoapBinding</con:interface>
      <con:operation>getSettingChildNodes</con:operation>
      <con:request name="GUI_getSettingChildNodes-userName-BT" id="4f9c02c6-07fa-485b-83f5-ae70d3e3b0da">
        <con:settings>
          <con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;xml-fragment/></con:setting>
        </con:settings>
        <con:encoding>UTF-8</con:encoding>
        <con:endpoint>${#Project#drc-GUIService-URL}</con:endpoint>
        <con:request><![CDATA[<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:type="http://directrecharge.o2.com/ws/drcgui/v1/" xmlns:v1="http://directrecharge.o2.com/ws/common/settings/v1/">
   <soapenv:Header/>
   <soapenv:Body>
      <v1:getSettingChildNodes>
         <settingPath>
            <settingName>com.o2.directrecharge.core.settings.SettingsRootCategoryEnum.MFT_ROOT</settingName>
            <settingName>com.o2.directrecharge.adapter.mft.PaymentStandardsEnum.BT</settingName>
            <settingName>com.o2.directrecharge.adapter.mft.MFTSettingsEnum.SSH_NAME</settingName>
         </settingPath>
      </v1:getSettingChildNodes>
   </soapenv:Body>
</soapenv:Envelope>]]></con:request>
        <con:assertion type="SOAP Response" id="6095dc36-6354-489f-9c3f-7008d934a9a1"/>
        <con:assertion type="Schema Compliance" id="8ff4d012-227e-4d6b-996e-5f2becf7d4ab">
          <con:configuration/>
        </con:assertion>
        <con:assertion type="SOAP Fault Assertion" id="c763efec-5e2a-49f8-9170-35713589853c"/>
        <con:credentials>
          <con:selectedAuthProfile>Inherit From Parent</con:selectedAuthProfile>
          <con:authType>No Authorization</con:authType>
        </con:credentials>
        <con:jmsConfig JMSDeliveryMode="PERSISTENT"/>
        <con:wsaConfig mustUnderstand="NONE" version="200508"/>
        <con:wsrmConfig version="1.2"/>
        <con:environmentSpec>
          <con:entry environmentId="e385afea-1153-4d90-83b9-3b49a724f0ea">
            <con:authProfile>Inherit From Parent</con:authProfile>
          </con:entry>
        </con:environmentSpec>
      </con:request>
    </con:config>
  </con:testStep>
  <con:testStep type="transfer" name="Property Transfer-settingsValues" id="f21460da-23c7-42bb-bb9a-533f86375ed9">
    <con:settings/>
    <con:config xsi:type="con:PropertyTransfersStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
      <con:transfers setNullOnMissingSource="true" transferTextContent="true" failOnError="false" ignoreEmpty="false" transferToAll="false" entitize="false" transferChildNodes="false">
        <con:name>path</con:name>
        <con:sourceType>Response</con:sourceType>
        <con:sourceStep>GUI_getSettingChildNodes-sftpPath-BT</con:sourceStep>
        <con:sourcePath>declare namespace ns2='http://directrecharge.o2.com/ws/common/settings/v1/';
//ns2:getSettingChildNodesResponse[1]/parentEntry[1]/value[1]</con:sourcePath>
        <con:targetType>targetPath</con:targetType>
        <con:targetStep>#TestCase#</con:targetStep>
        <con:targetPath/>
        <con:upgraded>true</con:upgraded>
      </con:transfers>
      <con:transfers setNullOnMissingSource="true" transferTextContent="true" failOnError="false" disabled="false" entitize="false" ignoreEmpty="false" transferChildNodes="false" transferToAll="false" useXQuery="false">
        <con:name>user</con:name>
        <con:sourceType>Response</con:sourceType>
        <con:sourceStep>GUI_getSettingChildNodes-userName-BT</con:sourceStep>
        <con:sourcePath>declare namespace ns2='http://directrecharge.o2.com/ws/common/settings/v1/';
//ns2:getSettingChildNodesResponse[1]/parentEntry[1]/value[1]</con:sourcePath>
        <con:targetType>targetUser</con:targetType>
        <con:targetStep>#TestCase#</con:targetStep>
        <con:targetPath/>
        <con:type>XPATH</con:type>
        <con:targetTransferType>XPATH</con:targetTransferType>
        <con:upgraded>true</con:upgraded>
      </con:transfers>
    </con:config>
  </con:testStep>
  <con:testStep type="groovy" name="Groovy Script-CopiedFileToDRC" id="36492de7-a706-4c71-9bb5-01238229f4e2">
    <con:settings/>
    <con:config>
      <script>/*
 * This script copy generated files from local machine to drc via sftp
 * Date: 2020-11-11
 * Autor: Michael Gordon
*/

@Grab(group='commons-net', module='commons-net', version='2.0')
@Grab(group='com.jcraft', module='jsch', version='0.1.51')

import org.apache.commons.net.ftp.FTPSClient
import com.jcraft.jsch.*;

/////////////////////////Configs/////////////////////////////
String ftpdomain = context.expand( '${#Project#drc-sftp-server}' )
int ftpport = 22
String ftppassword =context.expand( '${#Project#drc-sftp-password}' )
String ftpusername = context.expand( '${#TestCase#targetUser}' )
String localfilelocation = context.expand( '${#TestCase#inSourcePath}' ).replace('\\','/')
String remotefilelocation = context.expand( '${#TestCase#targetPath}' )
log.info('Local path is: - ' +localfilelocation)
log.info('Target path on sftp-server: - ' +ftpdomain+remotefilelocation)
/////////////////////////////////////////////////////////////
// make sure, file is exist
assert new File( localfilelocation).exists()

    	Session session = null;
     Channel channel = null;	
     
    try {
    	log.info("Starting sftp upload process")	
        JSch ssh = new JSch();
        		
        session = ssh.getSession(ftpusername, ftpdomain, ftpport);
        session.setConfig("StrictHostKeyChecking", "no"); //auto accept secure host
        session.setPassword(ftppassword);
        session.connect();
        log.info("Connected to session")
        		
        channel = session.openChannel("sftp");
        channel.connect();
        log.info("Connected to channel")
        		
        ChannelSftp sftp = (ChannelSftp) channel;        
        sftp.put(localfilelocation, remotefilelocation);
        log.info("File Uploaded " + localfilelocation + " TO " + remotefilelocation)
        
     }  catch (Exception e) {
			log.error("Exception during uploding of '"   + localfilelocation + "' to '" + remotefilelocation +"' - " + e)
        		 throw e
        }
        finally {
			if (session != null) 
				try { 
					session.disconnect()
					log.info("Disconnected from session") 
					} catch (Exception e) {
						log.error("Exception during disconnection from sftp session, igore - " + e)
					}	
			if (channel != null) 
				try { 
					channel.disconnect()
					log.info("Disconnected from channel") 
					} catch (Exception e) {
						log.error("Exception during disconnection from sftp session, igore - " + e)
						}
			log.info("sftp upload process completed")
		}</script>
    </con:config>
  </con:testStep>
  <con:properties>
    <con:property>
      <con:name>inSourcePath</con:name>
      <con:value>D:/Projects/Telefonica/DirectReCharge/TestOutput/soapUI/CAMT54-Files/2022-09-07_C54_DE99999999999999999990_EUR_393400.xml</con:value>
    </con:property>
    <con:property>
      <con:name>targetPath</con:name>
      <con:value xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">/var/MFT/drc1/bt_camt054</con:value>
    </con:property>
    <con:property>
      <con:name>targetUser</con:name>
      <con:value xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">drcbuild</con:value>
    </con:property>
  </con:properties>
  <con:reportParameters/>
  <con:breakPoints>
    <con:testStepId>5d3cd23d-80ff-423d-a476-d6497eb5e295</con:testStepId>
    <con:status>NONE</con:status>
    <con:properties/>
  </con:breakPoints>
  <con:breakPoints>
    <con:testStepId>be31f642-592f-412e-ba3d-54e43de6b53c</con:testStepId>
    <con:status>NONE</con:status>
    <con:properties/>
  </con:breakPoints>
  <con:breakPoints>
    <con:testStepId>dfcd5f46-58fe-4a26-8a87-fcb2563274dc</con:testStepId>
    <con:status>NONE</con:status>
    <con:properties/>
  </con:breakPoints>
  <con:breakPoints>
    <con:testStepId>7a5d8b9f-4087-495c-bfd3-ed1151d826ee</con:testStepId>
    <con:status>NONE</con:status>
    <con:properties/>
  </con:breakPoints>
  <con:environmentSpec>
    <con:entry environmentId="e385afea-1153-4d90-83b9-3b49a724f0ea">
      <con:authProfile>Inherit From Parent</con:authProfile>
    </con:entry>
  </con:environmentSpec>
</con:testCase>
