<?xml version="1.0" encoding="UTF-8"?>
<con:mockOperation name="incrementBalance" id="71b7584a-0feb-433a-9721-a09b40f68eb3" interface="BalanceManagement-SOAPBinding" operation="incrementBalance" xmlns:con="http://eviware.com/soapui/config">
  <con:settings>
    <con:setting id="c6abe8f0-c892-468c-89d9-589be5255c5bfileName">incrementBalance</con:setting>
    <con:setting id="71b7584a-0feb-433a-9721-a09b40f68eb3fileName">incrementBalance</con:setting>
  </con:settings>
  <con:defaultResponse>Response-Default</con:defaultResponse>
  <con:dispatchStyle>SCRIPT</con:dispatchStyle>
  <con:dispatchConfig/>
  <con:dispatchPath>/*
 * This script read values from request and set in virt properties for response 
 * Date: 09.02.2017, change at 11.04.19
 * Autor: Michael Gordon
*/

 // read default values from project properties
 def sMSISDNPrefixException = context.expand( '${#Project#MOCK-Prefix-OCS10-rechargeAccount-CustomException}' ) 
 def sMSISDNUnknown = context.expand( '${#Project#MSISDN_OCS_Unknown}') 
 
 // set default values from virt properties
 def iDEFAULTBalance = context.expand('${#MockService#DEFAULT-balance}').toInteger() 
 def sErrorType_Default = context.expand('${#MockService#DEFAULT-ErrorType}')
 def sErrorCode_Default=context.expand('${#MockService#DEFAULT-ErrorCode}')
 def sErrorText_Default=context.expand('${#MockService#DEFAULT-ErrorText}')

 // set virt properties for soap fault responses
 context.mockService.setPropertyValue('Exception-ErrorType',sErrorType_Default)
 context.mockService.setPropertyValue('Exception-ErrorCode',sErrorCode_Default)
 context.mockService.setPropertyValue('Exception-ErrorText',sErrorText_Default)

 // read values from incommning request
 def holder = new com.eviware.soapui.support.XmlHolder( mockRequest.requestContent ) 
 def sHeaderMsgId=holder.getNodeValue("declare namespace ns1='http://schemas.xmlsoap.org/ws/2004/08/addressing';//ns1:MessageID[1]")
 def sApplicationID=holder.getNodeValue("declare namespace ns1='http://www.telefonica.com/OCS/To2DE/OCS_types/v1_1'; //ns1:incrementBalanceRequest[1]/ns1:appInfo[1]/ns1:applicationId[1]")
 def sReference=holder.getNodeValue("declare namespace ns1='http://www.telefonica.com/OCS/To2DE/OCS_types/v1_1'; //ns1:incrementBalanceRequest[1]/ns1:appInfo[1]/ns1:reference[1]") 
 def sMSISDN = holder.getNodeValue("declare namespace ns1='http://www.telefonica.com/OCS/To2DE/OCS_types/v1_1'; //ns1:incrementBalanceRequest[1]/ns1:subscriberId[1]//ns1:e164Number[1]")
 def sAmount=holder.getNodeValue("declare namespace ns1='http://www.telefonica.com/OCS/To2DE/OCS_types/v1_1'; //ns1:incrementBalanceRequest[1]/ns1:amount[1]")
 def sWalledID=holder.getNodeValue("declare namespace ns1='http://www.telefonica.com/OCS/To2DE/OCS_types/v1_1';//ns1:incrementBalanceRequest[1]/ns1:walletId[1]")
  
 log.info('OCS10-BalanceManagement.incrementBalance: Return response for request with msisdn ' + sMSISDN)
 log.info('MessageID is: ' + sHeaderMsgId) 	 
 log.info('applicationId is: ' + sApplicationID)
 log.info('reference is: ' + sReference)
 log.info('amount is: ' + sAmount)

  // check msissdn
 if(sMSISDN==null || sMSISDN.length()&lt;1 || sMSISDN.length()>15 || !sMSISDN.toString().isNumber() ){
	context.mockService.setPropertyValue('Exception-ErrorCode','5')
 	context.mockService.setPropertyValue('Exception-ErrorText','Incoherent parameters: MSISDN is missed, to short, to long or contains not allowed signs')
	return 'Response-soapFault-ServiceException'
 }
 
 // if msisd=constant msisdn unknown, return permanent errorcode=1, it is default code
 if (sMSISDN.toString()==sMSISDNUnknown.toString()){
 	context.mockService.setPropertyValue('Exception-ErrorCode','1')
 	context.mockService.setPropertyValue('Exception-ErrorText','Unknown subscriberId')
 	return 'Response-soapFault-ServiceException'
 }

// check input parameters from request
String sResultCode='5'
String sResultDesc='Incoherent parameters:-'
def lstMediaType = ['23','25','27','28','35','38','39','40','43','44','60','61','70','71']
def lstTopup=['M0','M1','M2','M3','M4','M5','M6','M7','M8','M9','MA','MB']
// check: MessageId in soapHeader. Must be uuid and 36 signs long
if (sHeaderMsgId==null || sHeaderMsgId.length()&lt;1 ||
	sHeaderMsgId.replace('urn:uuid:','').length()!=36)
	sResultDesc=sResultDesc + 'MessageID in soapHeader is missed or not uuid!'
// check applicationId. Must be D+mediaType. Ex. D35
else if (sApplicationID==null ||  sApplicationID.length()!=3 || 
	!lstMediaType.contains(sApplicationID[1..2]) || sApplicationID[0]!='D')
	sResultDesc=sResultDesc + 'applicationId in request is emtpy or contains not allowed value! Must be D + media type'
// check reference. Started with mediaType. Ex. 350000010006278
else if (sReference==null ||  sReference.length()&lt;9 ||  sReference.length()>64 ||
	!lstMediaType.contains(sReference[0..1]))
	sResultDesc=sResultDesc + 'reference in request is emtpy, not 9 till 64 signs long or does not contain media type!'
// check walletId=balanceID=2
else if (sWalledID==null || !['2','3'].contains(sWalledID))
	sResultDesc=sResultDesc + 'walletId in request contains wrong value. Allowed only 2 or 3!'
// Two last signs in applicationId must be = first two signs in reference and in rechargeType
else if (sApplicationID[1..2]!=sReference[0..1])
	sResultDesc=sResultDesc + 'Media type in applicationId and reference from request is not identical!'
else	// all values in request are valid, clear error description.
	sResultDesc=''

// if error description is not empty, send error response with error-message
if(sResultDesc!=''){
	context.mockService.setPropertyValue('Exception-ErrorCode',sResultCode)
	context.mockService.setPropertyValue('Exception-ErrorText',sResultDesc)
	return 'Response-soapFault-ServiceException'  
} 

 // convert balance change to integer
 def iBalanceChange=sAmount.toInteger()
 // set request values to virt properties
 context.mockService.setPropertyValue('incrementBalance-applicationId',sApplicationID)
 context.mockService.setPropertyValue('incrementBalance-reference',sReference)
 context.mockService.setPropertyValue('incrementBalance-e164Number',sMSISDN)
 context.mockService.setPropertyValue('incrementBalance-balanceChange',sAmount)
 // set balance to default balance + change balance
 context.mockService.setPropertyValue('incrementBalance-balance',(iDEFAULTBalance+iBalanceChange).toString())
  
 // make sure, soap fault response is not ordered
 if (sMSISDN.length()&lt;14 || sMSISDN[0..4]!=sMSISDNPrefixException){
	 return 'Response-Default'
 }

 // create ordered soap fault exception
 // set error code, if response is soap fault
 context.mockService.setPropertyValue('Exception-ErrorCode',sMSISDN.substring(6).toInteger().toString())
 switch ( sMSISDN[5] ) {
    case '1':		// service exception, permanent    		
         	return 'Response-soapFault-ServiceException' 
    case '2':		// service exception, transient   
    		context.mockService.setPropertyValue('Exception-ErrorType','TRANSIENT')        	
          return 'Response-soapFault-ServiceException' 
    case '3':		// policy exception, transient        	
        	return 'Response-soapFault-PolicyException'
    default:
    		context.mockService.setPropertyValue('Exception-ErrorCode',sErrorCode_Default)
        	return 'Response-soapFault-ServiceException' 
}</con:dispatchPath>
  <con:dispatchXPath/>
  <con:routeScript/>
  <con:response name="Response-Default" id="98ec782f-5f89-45b9-983f-a63608cb8dfc" httpResponseStatus="200" encoding="UTF-8" dataSource="">
    <con:settings/>
    <con:responseContent><![CDATA[<S:Envelope xmlns:S="http://schemas.xmlsoap.org/soap/envelope/">
   <S:Header>
      <add:MessageID xmlns:add="http://schemas.xmlsoap.org/ws/2004/08/addressing">urn:uuid:${#Project#GUID}</add:MessageID>
   </S:Header>
   <S:Body>
      <ns2:incrementBalanceResponse xmlns="http://schemas.xmlsoap.org/ws/2004/08/addressing" xmlns:ns2="http://www.telefonica.com/OCS/To2DE/OCS_types/v1_1" xmlns:ns3="http://www.w3.org/2000/09/xmldsig#" xmlns:ns4="http://schemas.xmlsoap.org/ws/2002/04/secext">
         <ns2:appInfo>
            <ns2:applicationId>${#MockService#incrementBalance-applicationId}</ns2:applicationId>
            <ns2:reference>${#MockService#incrementBalance-reference}</ns2:reference>
         </ns2:appInfo>
         <ns2:result>
            <ns2:opReference>${#Project#GUID_Moved-}</ns2:opReference>
            <ns2:opExecutionDate>${#Project#DateTime_Current_Offset}</ns2:opExecutionDate>
            <ns2:opCost currencyCode="${#MockService#DEFAULT-currencyCode}" exponent="${#MockService#DEFAULT-exponent}">${#MockService#DEFAULT-opCost}</ns2:opCost>
            <ns2:subscriberId>
               <ns2:e164Number>${#MockService#incrementBalance-e164Number}</ns2:e164Number>
            </ns2:subscriberId>
            <ns2:serviceProviderId>${#MockService#DEFAULT-serviceProviderId}</ns2:serviceProviderId>
            <ns2:balance currencyCode="${#MockService#DEFAULT-currencyCode}" exponent="${#MockService#DEFAULT-exponent}">${#MockService#incrementBalance-balance}</ns2:balance>
            <ns2:lifeCycleStatus>
               <ns2:state>A</ns2:state>
               <ns2:subState>R</ns2:subState>
            </ns2:lifeCycleStatus>
            <ns2:tariffPlanId>${#MockService#DEFAULT-tariffPlanId}</ns2:tariffPlanId>
         </ns2:result>
         <ns2:changedWalletInfo>
            <ns2:walletId>${#MockService#DEFAULT-walletId}</ns2:walletId>
            <ns2:balance currencyCode="${#MockService#DEFAULT-currencyCode}" exponent="${#MockService#DEFAULT-exponent}">${#MockService#incrementBalance-balance}</ns2:balance>
            <ns2:balanceChange currencyCode="${#MockService#DEFAULT-currencyCode}" exponent="${#MockService#DEFAULT-exponent}">${#MockService#incrementBalance-balanceChange}</ns2:balanceChange>
            <ns2:expirationDate>${#Project#Date_Future_Offset}</ns2:expirationDate>
         </ns2:changedWalletInfo>
      </ns2:incrementBalanceResponse>
   </S:Body>
</S:Envelope>]]></con:responseContent>
    <con:wsaConfig mustUnderstand="NONE" version="200508" action="incrementBalance"/>
  </con:response>
  <con:response name="Response-soapFault-ServiceException" id="c2f76b81-306d-4760-bb0e-a6788b3ec3d0" httpResponseStatus="500" encoding="UTF-8" dataSource="">
    <con:settings/>
    <con:responseContent><![CDATA[<soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">
   <soap:Body>
      <soap:Fault>
         <faultcode>soap:Server</faultcode>
         <faultstring>${#MockService#faultString}</faultstring>
         <detail>
            <ns3:serviceException xmlns="http://schemas.xmlsoap.org/ws/2004/08/addressing" xmlns:ns2="http://www.w3.org/2000/09/xmldsig#" xmlns:ns3="http://www.telefonica.com/OCS/To2DE/OCS_types/v1_1" xmlns:ns4="http://schemas.xmlsoap.org/ws/2002/04/secext">
               <ns3:errorCode>${#MockService#Exception-ErrorCode}</ns3:errorCode>
               <ns3:errorType>${#MockService#Exception-ErrorType}</ns3:errorType>
               <ns3:text>${#MockService#Exception-ErrorText}</ns3:text>             
            </ns3:serviceException>
         </detail>
      </soap:Fault>
   </soap:Body>
</soap:Envelope>]]></con:responseContent>
    <con:wsaConfig mustUnderstand="NONE" version="200508" action="incrementBalance"/>
  </con:response>
  <con:response name="Response-soapFault-PolicyException" id="3994e902-8c26-445c-ac01-c7eaa68ef475" httpResponseStatus="500" encoding="UTF-8" dataSource="">
    <con:settings/>
    <con:responseContent><![CDATA[<soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">
   <soap:Body>
      <soap:Fault>
         <faultcode>soap:Server</faultcode>
         <faultstring>${#MockService#faultString}</faultstring>
         <detail>
            <ns4:policyException xmlns="http://schemas.xmlsoap.org/ws/2004/08/addressing" xmlns:ns2="http://www.w3.org/2000/09/xmldsig#" xmlns:ns3="http://schemas.xmlsoap.org/ws/2002/04/secext" xmlns:ns4="http://www.telefonica.com/OCS/To2DE/OCS_types/v1_1">
               <ns4:errorCode>${#MockService#Exception-ErrorCode}</ns4:errorCode>
               <ns4:errorType>${#MockService#DEFAULT-ErrorType}</ns4:errorType>
               <ns4:text>${#MockService#Exception-ErrorText}</ns4:text>
               <ns4:variables>${#Project#Random10}${#Project#Random10}</ns4:variables>
            </ns4:policyException>
         </detail>
      </soap:Fault>
   </soap:Body>
</soap:Envelope>]]></con:responseContent>
    <con:wsaConfig mustUnderstand="NONE" version="200508" action="incrementBalance"/>
  </con:response>
</con:mockOperation>
